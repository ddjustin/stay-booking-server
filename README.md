# stay-booking-server

# ðŸ§  ìˆ™ì†Œ ì˜ˆì•½ ì„œë²„ â€” íŠ¸ëžœìž­ì…˜ & ë™ì‹œì„± ì œì–´ ì„¤ê³„

---

## ðŸ“˜ ê³µë¶€í•  ìˆ˜ ìžˆëŠ” ì§€ì‹

- íŠ¸ëžœìž­ì…˜ (Transaction)
- ê²©ë¦¬ ìˆ˜ì¤€ (Isolation Level)
- ë¹„ê´€ì  ë½ vs ë‚™ê´€ì  ë½ (Pessimistic vs Optimistic Lock)
- ë³‘ëª© í˜„ìƒ (Bottleneck)

---

## ðŸŽ¯ ëª©í‘œ

- ì—¬ëŸ¬ ì‚¬ìš©ìžê°€ ë™ì‹œì— ê°™ì€ ë°©ì„ ì˜ˆì•½í•  ë•Œ  
  â†’ **ë‹¨ í•œ ëª…ë§Œ ì„±ê³µ**í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” **ì‹¤íŒ¨**
- íŠ¸ëžœìž­ì…˜ê³¼ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì´í•´í•˜ê³  ì œì–´

---

## ðŸŽ¯ ì˜ˆì•½ ì‹œìŠ¤í…œì— ì í•©í•œ ê²©ë¦¬ ìˆ˜ì¤€

> ðŸ’¡ **REPEATABLE READ (ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°)**  
> ë˜ëŠ” PostgreSQL ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©  
> PostgreSQL ê¸°ë³¸: **READ COMMITTED**

---

## ðŸ’¬ ì´ìœ 

| í•­ëª© | ì„¤ëª… |
|------|------|
| **READ COMMITTED** | ì¼ë°˜ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¸ëžœìž­ì…˜ì— ì¶©ë¶„í•¨. PostgreSQL ê¸°ë³¸ê°’. ì»¤ë°‹ëœ ë°ì´í„°ë§Œ ë³´ê¸° ë•Œë¬¸ì— Dirty Read ë°©ì§€ |
| **REPEATABLE READ** | ì¤‘ê°„ì— ë‹¤ë¥¸ íŠ¸ëžœìž­ì…˜ì´ ë°ì´í„°ë¥¼ ë°”ê¿”ë„ ë‚´ íŠ¸ëžœìž­ì…˜ ë‚´ì—ì„œëŠ” ì¼ê´€ëœ ë°ì´í„° ìœ ì§€ |
| **SERIALIZABLE** | ì™„ë²½í•œ ì •í•©ì„±ì´ ë³´ìž¥ë˜ì§€ë§Œ, ë½ ì¶©ëŒì´ ë§Žì•„ì§€ê³  ì†ë„ê°€ ë§¤ìš° ëŠë ¤ì§ |

ðŸ“˜ í˜„ì‹¤ì ìœ¼ë¡œ **â€œREAD COMMITTED + FOR UPDATEâ€** ì¡°í•©ì´ë©´ ì¶©ë¶„ížˆ ì•ˆì „í•˜ë‹¤.  
ëŒ€ë¶€ë¶„ì˜ ì€í–‰, ì˜ˆì•½, ê²°ì œ ì‹œìŠ¤í…œì´ ì´ ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.

---

## ðŸ§© Prisma íŠ¸ëžœìž­ì…˜ êµ¬í˜„ (with `FOR UPDATE`)

### âš™ï¸ `FOR UPDATE`ì˜ ì—­í• 

> íŠ¸ëžœìž­ì…˜ì´ ì‹¤í–‰ ì¤‘ì¸ ë™ì•ˆ,  
> í•´ë‹¹ Row(ë°©)ì— ëŒ€í•´ **ë‹¤ë¥¸ íŠ¸ëžœìž­ì…˜ì´ ì½ê±°ë‚˜ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ ìž ê¸ˆ(lock)** ì„ ê±°ëŠ” SQL êµ¬ë¬¸ì´ë‹¤.

- Aê°€ Room #1ì„ `FOR UPDATE`ë¡œ ì¡°íšŒ â†’ **ë½ ê±¸ë¦¼**
- Bê°€ ê°™ì€ Row ì ‘ê·¼ ì‹œ â†’ **A íŠ¸ëžœìž­ì…˜ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°(block)**
- Aê°€ ì»¤ë°‹(commit)í•˜ë©´ Bê°€ ì‹¤í–‰ë¨
- Aê°€ ë°©ì„ ì˜ˆì•½ ì™„ë£Œ í›„ `isAvailable=false`ë¡œ ë°”ê¾¸ë©´  
  BëŠ” ê·¸ê±¸ ë³´ê³  â€œì´ë¯¸ ì˜ˆì•½ëœ ë°©ìž…ë‹ˆë‹¤.â€ ì—ëŸ¬ ë°œìƒ

---

## ðŸ§  Prisma íŠ¸ëžœìž­ì…˜ì˜ ë™ìž‘ ì›ë¦¬

| Prisma ê¸°ëŠ¥ | ì„¤ëª… |
|--------------|------|
| `prisma.$transaction()` | ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ëŠ” íŠ¸ëžœìž­ì…˜ ì‹¤í–‰ |
| `isolationLevel` | íŠ¸ëžœìž­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ì„¤ì • (PostgreSQL ê¸°ì¤€ `ReadCommitted` / `RepeatableRead` / `Serializable` ì§€ì›) |
| `$queryRawUnsafe` | ì§ì ‘ SQL ì‹¤í–‰ (ì—¬ê¸°ì„œ `FOR UPDATE` ì‚¬ìš© ê°€ëŠ¥) |

---

## ðŸ“Š ìš”ì²­ ë™ìž‘ ì‹œë‚˜ë¦¬ì˜¤

| ì‹œì  | ìœ ì € A | ìœ ì € B |
|------|---------|---------|
| T1 | Room #1 ì¡°íšŒ (`FOR UPDATE` â†’ Lock íšë“) | ëŒ€ê¸° ì¤‘ |
| T2 | Room ì˜ˆì•½ â†’ `isAvailable = false` | ëŒ€ê¸° ì¤‘ |
| T3 | íŠ¸ëžœìž­ì…˜ Commit | Lock í•´ì œ |
| T4 | Room ì¡°íšŒ â†’ `isAvailable = false` í™•ì¸ | ì˜ˆì•½ ì‹¤íŒ¨ (ì´ë¯¸ ì˜ˆì•½ë¨) |

---

## âœ… ê²°ë¡  ìš”ì•½

| ê°œë… | ì˜ë¯¸ | ì„¤ì • |
|------|------|------|
| **íŠ¸ëžœìž­ì…˜** | ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ëŠ” ë…¼ë¦¬ ë‹¨ìœ„ | `prisma.$transaction()` |
| **ê²©ë¦¬ ìˆ˜ì¤€** | íŠ¸ëžœìž­ì…˜ ê°„ ë°ì´í„° ì ‘ê·¼ ë²”ìœ„ | `ReadCommitted` |
| **ë½ (FOR UPDATE)** | íŠ¹ì • ë°ì´í„°(row)ì— ì ‘ê·¼ ìž ê¸ˆ | `SELECT ... FOR UPDATE` |
| **ì´ ì¡°í•© ê²°ê³¼** | ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ì™€ë„ ë‹¨ í•œ ëª…ë§Œ ì˜ˆì•½ ê°€ëŠ¥ | âœ… ì™„ë²½í•œ ë°ì´í„° ì •í•©ì„± ë³´ìž¥ |

---

> ðŸ’¡ **ê²°ë¡ :**  
> ë™ì‹œì— 100ëª…ì´ ê°™ì€ ë°©ì„ ì˜ˆì•½í•˜ë”ë¼ë„,  
> **ë‹¨ í•œ ëª…ë§Œ ì„±ê³µ**í•˜ëŠ” ì•ˆì „í•œ íŠ¸ëžœìž­ì…˜ ê¸°ë°˜ ì„œë²„ êµ¬ì¡°ë¥¼ ë§Œë“ ë‹¤.

